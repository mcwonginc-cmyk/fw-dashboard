<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Latest Approved Firmware</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#f7f7f8; color:#111; margin:0 }
    .wrap { max-width:1000px; margin:2rem auto; padding:0 1rem }
    h1 { font-size:1.6rem; margin:0 0 1rem }
    .bar { display:flex; gap:.5rem; align-items:center; margin-bottom:1rem; flex-wrap:wrap }
    input, select { padding:.5rem .6rem; border:1px solid #ddd; border-radius:.6rem; font-size:.95rem }
    table { width:100%; border-collapse:collapse; background:#fff; border-radius:1rem; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,.05) }
    th, td { padding:.75rem .9rem; border-bottom:1px solid #eee; text-align:left; font-size:.95rem }
    th { background:#fafafa; font-weight:600 }
    tr:last-child td { border-bottom:none }
    .tag { font-size:.8rem; padding:.2rem .45rem; border-radius:.5rem; border:1px solid; display:inline-block }
    .ok { color:#0a7a2a; border-color:#a9e3b9; background:#e9f8ee }
    .beta { color:#8a6100; border-color:#f5d98c; background:#fff7e0 }
    .muted { color:#666; font-size:.9rem }
    footer { margin-top:1rem; color:#666; font-size:.85rem; text-align:center }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Latest Approved Firmware</h1>
    <div class="bar">
      <input id="q" placeholder="Search product name, code, or HW rev…" />
      <label class="muted"><input type="checkbox" id="showBeta" /> Show beta</label>
      <label class="muted">Sort by
        <select id="sortKey">
          <option value="product_name">Product name</option>
          <option value="product_code">Product code</option>
          <option value="released_at">Release date</option>
          <option value="version">Version</option>
        </select>
      </label>
      <span id="status" class="muted" style="margin-left:auto">Loading…</span>
    </div>

    <table>
      <thead>
        <tr>
          <th>Product</th>
          <th>Code / HW</th>
          <th>Channel</th>
          <th>Version</th>
          <th>Released (UTC)</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <footer>Info-only dashboard (no downloads). Keep repo private; site is public on GitHub Free.</footer>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const state = { data: [], q: "", showBeta: false, sortKey: "product_name" };
      const $ = (s)=>document.querySelector(s);
      const rowsEl = $("#rows"), qEl = $("#q"), betaEl = $("#showBeta"), sortEl = $("#sortKey"), statusEl = $("#status");

      function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function isoUTC(s){ const d = new Date(s); return isNaN(d) ? "" : d.toISOString().replace(".000Z","Z"); }
      function cap(s){ s = String(s||""); return s.charAt(0).toUpperCase()+s.slice(1); }

      function render() {
        const needle = state.q.trim().toLowerCase();
        let list = state.data
          .filter(r => state.showBeta ? true : r.channel !== "beta")
          .filter(r =>
            (r.product_name||"").toLowerCase().includes(needle) ||
            (r.product_code||"").toLowerCase().includes(needle) ||
            (r.hardware_rev||"").toLowerCase().includes(needle)
          );

        list.sort((a,b)=>{
          const k = state.sortKey;
          if (k === "released_at") return new Date(b.released_at) - new Date(a.released_at);
          if (k === "version") return (b.version||"").localeCompare(a.version||"", undefined, {numeric:true, sensitivity:"base"});
          return String(a[k]||"").localeCompare(String(b[k]||""));
        });

        rowsEl.innerHTML = list.map(r => `
          <tr>
            <td>${esc(r.product_name)}</td>
            <td><code>${esc(r.product_code)}</code>${r.hardware_rev ? " • HW " + esc(r.hardware_rev) : ""}</td>
            <td><span class="tag ${r.channel==="approved"?"ok":"beta"}">${esc(cap(r.channel))}</span></td>
            <td><code>${esc(r.version)}</code></td>
            <td><code>${isoUTC(r.released_at)}</code></td>
            <td>${esc(r.notes||"")}</td>
          </tr>
        `).join("");
      }

      qEl.addEventListener("input", e => { state.q = e.target.value; render(); });
      betaEl.addEventListener("change", e => { state.showBeta = e.target.checked; render(); });
      sortEl.addEventListener("change", e => { state.sortKey = e.target.value; render(); });

      // Build a safe URL relative to the current page and bust cache
      const url = new URL('versions.json', window.location.href);
      url.searchParams.set('cb', Date.now());

      fetch(url.toString(), { cache: 'no-store' })
        .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
        .then(json => { state.data = json; statusEl.textContent = 'Last updated: ' + new Date().toLocaleString(); render(); })
        .catch(err => {
          console.error('Failed to load versions.json:', err);
          statusEl.textContent = 'Error loading versions.json: ' + err.message;
        });
    });
  </script>
</body>
</html>
